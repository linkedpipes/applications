os: "linux"

stages:
  - name: build
    if: type = pull_request OR branch IN (master, dev) OR commit_message =~ /(\[Travis\])/
  - name: tests
    if: type = pull_request OR branch IN (master, dev) OR commit_message =~ /(\[Travis\])/
  - name: deploy
    if: type = pull_request AND branch IN (master, dev) OR commit_message =~ /(\[Travis-Deploy\])/

jobs:
  include:
    - stage: build
      language: node_js
      node_js:
        - stable
      name: "Frontend"
      before_script:
        - cd src/frontend
        - curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.13.0
        - export PATH="$HOME/.yarn/bin:$PATH"
      cache:
        yarn: true
        directories:
          - src/frontend/node_modules
      script:
        - yarn install --frozen-lockfile --check-files
        - yarn run build

    - name: "Backend"
      language: java
      jdk: openjdk10
      before_cache:
        - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
        - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
      cache:
        directories:
          - $HOME/.gradle/caches/
          - $HOME/.gradle/wrapper/
      services:
        - postgresql
      before_script:
        - cd src/backend
        - psql -c "CREATE DATABASE lpa;" -U postgres
        - psql -c "CREATE USER lpa WITH PASSWORD 'example';" -U postgres
      script:
        - ./gradlew assemble

    - stage: tests
      name: "Backend unit tests"
      language: java
      jdk: openjdk10
      before_cache:
        - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
        - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
      cache:
        directories:
          - $HOME/.gradle/caches/
          - $HOME/.gradle/wrapper/
      services:
        - postgresql
        - docker
      before_script:
        - cd src/backend
        - psql -c "CREATE DATABASE lpa;" -U postgres
        - psql -c "CREATE USER lpa WITH PASSWORD 'example';" -U postgres
      script:
        - ./gradlew -Dspring.datasource.url=jdbc:postgresql://localhost:5432/lpa test
        - ./gradlew jacocoTestReport
        - ./gradlew sendCoverageToCodacy

    - name: "Backend integration tests"
      language: java
      jdk: openjdk10
      before_cache:
        - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
        - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
      cache:
        directories:
          - $HOME/.gradle/caches/
          - $HOME/.gradle/wrapper/
      services:
        - postgresql
        - docker
      before_script:
        - cd src/backend
        - psql -c "CREATE DATABASE lpa;" -U postgres
        - psql -c "CREATE USER lpa WITH PASSWORD 'example';" -U postgres
      script:
        - ./gradlew dockerRun
        - ./gradlew -Dspring.datasource.url=jdbc:postgresql://localhost:5432/lpa -Dlpa.discoveryServiceUrl=http://localhost:9000 testIntegration

    - stage: deploy
      name: "Deploying Backend to DockerHub"
      sudo: required
      services:
        - docker
      script:
        - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"

        - cd src/backend
        - docker build -t linkedpipes/applications:backend --build-arg JAR_FILE=build/libs/backend-0.0.1.jar .
        - docker push linkedpipes/applications:backend

    - name: "Deploying Frontend to DockerHub"
      sudo: required
      services:
        - docker
      script:
        - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"

        - cd src/frontend
        - docker build -t linkedpipes/applications:frontend .
        - docker push linkedpipes/applications:frontend

        - docker build -t linkedpipes/applications:frontend-prod -f Dockerfile-prod .
        - docker push linkedpipes/applications:frontend-prod

notifications:
  slack:
    secure: k85vRAQg57BTbCXOVoNy9Z/ASmXSDTdQgySr/Pb8sGd0WiM5Cw6HJrvKabRyXgS1RI/e0DTHsQEciM6+tIiEVPaGxv21p2OxyEl3OSzClbD012blgFV4yYhj0MJJbO9oDil2TRfIsOPLcN5S3Yyeq5BMHi6cRAWjOqqFGJn0PJQ1ecLaGMOp93bRyjFsERh76xxljFD3FcT33s8uhvpPHPFCLcf/uJgjMbeOlUmpz6lSuGQmtmav3RjSLk+40sZWKDnV9zrk4cmz8DYWYl9X0jYjHBbp3aFDGIv9KkUdDrP+A5/wVk6Vxq/KhaE+x/JnV6WjsoAklGmSujkQB9kcpvz7eEhCYLHEJtFf4Ak17HzYFw+PmWKOQJgOSOHfWLoXsRY2I5qp/MnWVAvdCiGewrQ7/4ly34F4TUHhtMgCFihqQL+NabVybWaqp9UI5mG1pVGz3M9tO61GPtYTIiIClIeQ52zrpEnfWJxZ5fh03Ov/FL+nqrmR6KwKvdB2nq5p3hzHgqBriW0yI/x54dUc2CDJXDpwplRQ08GGvtYd4qKTz0z5vsOMBZY3UH/19A2YMU2P3Jp0Qk0GgRb9aJtN1JzmAL2gK47h+AR5laFLWKFt+atRF/GXr/SEqjdKCDwEGfuqs7YrMtSMYuY/qMIlZbuCIDu88ge6NTMuSgSVABI=
